apiVersion: apps/v1
kind: Deployment
metadata:
  name: registry-app
  labels:
    app: registry-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: registry-app
  template:
    metadata:
      labels:
        app: registry-app
    spec:
      containers:
      - name: registry-app
        image: 'quay.io/apicurio/apicurio-registry-sql:latest-snapshot'
        env:
          - name: REGISTRY_DATASOURCE_URL
            value: 'jdbc:postgresql://multitenant-sr-db-registry:5432/multitenantsrdb'
          - name: REGISTRY_DATASOURCE_USERNAME
            value: 'postgres'
          - name: REGISTRY_DATASOURCE_PASSWORD
            value: 'postgres'
          - name: AUTH_ENABLED
            value: 'true'
          - name: KEYCLOAK_URL
            value: 'http://localhost:8083/auth'
          - name: QUARKUS_OIDC_AUTH_SERVER_URL
            value: "http://keycloak:8080/auth/realms/demo-apicurio"
          - name: QUARKUS_OIDC_TLS_VERIFICATION
            value: none
          - name: KEYCLOAK_REALM
            value: 'demo-apicurio'
          - name: KEYCLOAK_UI_CLIENT_ID
            value: 'sr-ui'
          - name: KEYCLOAK_API_CLIENT_ID
            value: 'sr-api'
          - name: CORS_ALLOWED_ORIGINS
            value: "*"
        ports:
        - name: http
          containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: registry-app
spec:
  selector:
    app: registry-app
  type: LoadBalancer
  ports:
  - port: 8080
    targetPort: 8080
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: multitenant-sr-db-registry
spec:
  serviceName: multitenant-sr-db-service-registry
  selector:
    matchLabels:
      app: multitenant-sr-db-registry
  replicas: 1
  template:
    metadata:
      labels:
        app: multitenant-sr-db-registry
    spec:
      containers:
        - name: postgresql-db
          image: postgres:latest
          env:
            - name: POSTGRES_DB
              value: multitenantsrdb
            - name: POSTGRES_USER
              value: postgres
            - name: POSTGRES_PASSWORD
              value: postgres
            - name: PGDATA
              value: /data/pgdata
---
apiVersion: v1
kind: Service
metadata:
  name: multitenant-sr-db-registry
spec:
  selector:
    app: multitenant-sr-db-registry
  type: LoadBalancer
  ports:
  - port: 5432
    targetPort: 5432
